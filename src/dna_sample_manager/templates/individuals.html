{% extends "base.html" %}

{% block title %}Individuals - DNA Sample Manager{% endblock %}

{% block content %}
<div class="container-fluid">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people text-primary"></i> Individuals Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#individualModal" onclick="openNewModal()">
        <i class="bi bi-plus-lg"></i> New Individual
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
<div class="card-body filter-section">
    <div class="row g-3">
        <div class="col-md-4">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="searchInput" placeholder="Search by ID, family, project...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="familyFilter">
                <option value="">All Families</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="projectFilter">
                <option value="">All Projects</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="loadIndividuals()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
</div>
</div>

<!-- Table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Aliases</th>
                        <th>Family</th>
                        <th>Sex</th>
                        <th>Phenotype</th>
                        <th>Projects</th>
                        <th>Samples</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="individualsTable">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Individual Modal -->
<div class="modal fade" id="individualModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">New Individual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="individualForm">
                    <input type="hidden" id="individualId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Individual ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="individual_id" required placeholder="e.g., 1013.1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Aliases</label>
                            <input type="text" class="form-control" id="aliases" placeholder="Alternative IDs">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Family ID</label>
                            <input type="text" class="form-control" id="family_id" placeholder="e.g., AIMS_f1013">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sex</label>
                            <select class="form-select" id="sex">
                                <option value="">Unknown</option>
                                <option value="1">Male</option>
                                <option value="2">Female</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phenotype</label>
                            <input type="text" class="form-control" id="phenotype" placeholder="e.g., -9">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Other Family Codes</label>
                            <input type="text" class="form-control" id="other_family_codes">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Projects <small class="text-muted">(comma-separated)</small></label>
                            <input type="text" class="form-control" id="projects" placeholder="e.g., euaims, gBasis">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveIndividual()">
                    <i class="bi bi-check-lg"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Individual Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let individualsData = [];

async function loadFilters() {
    try {
        // Load families
        const famResp = await fetch('/api/families');
        const families = await famResp.json();
        const famSelect = document.getElementById('familyFilter');
        if (famSelect) {
            families.forEach(f => {
                famSelect.innerHTML += `<option value="${f}">${f}</option>`;
            });
        }
        
        // Load projects
        const projResp = await fetch('/api/projects');
        const projects = await projResp.json();
        const projSelect = document.getElementById('projectFilter');
        if (projSelect) {
            projects.forEach(p => {
                projSelect.innerHTML += `<option value="${p}">${p}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading filters:', error);
    }
}

async function loadIndividuals() {
    const search = document.getElementById('searchInput').value;
    const family = document.getElementById('familyFilter').value;
    const project = document.getElementById('projectFilter').value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (family) params.append('family', family);
    if (project) params.append('project', project);
    
    try {
        const response = await fetch('/api/individuals?' + params.toString());
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        // Handle both array and object response formats
        individualsData = Array.isArray(data) ? data : (data.individuals || []);
        console.log(`${individualsData.length} individuals loaded`);
        renderTable();
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('individualsTable').innerHTML = 
            '<tr><td colspan="8" class="text-center py-4 text-danger">Error loading data</td></tr>';
    }
}

function renderTable() {
    const tbody = document.getElementById('individualsTable');
    
    if (individualsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No individuals found</td></tr>';
        return;
    }
    
    tbody.innerHTML = individualsData.map(i => `
        <tr>
            <td><strong>${i.individual_id}</strong></td>
            <td>${i.aliases || '-'}</td>
            <td>${i.family_id || '-'}</td>
            <td><span class="badge ${i.sex === 1 ? 'bg-primary' : i.sex === 2 ? 'bg-danger' : 'bg-secondary'}">${i.sex_display}</span></td>
            <td>${i.phenotype || '-'}</td>
            <td><small>${i.projects ? i.projects.substring(0, 30) + (i.projects.length > 30 ? '...' : '') : '-'}</small></td>
            <td><span class="badge bg-info">${i.sample_count}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-info btn-action" onclick="showDetails(${i.id})" title="Details">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary btn-action" onclick="editIndividual(${i.id})" title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteIndividual(${i.id})" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function openNewModal() {
    document.getElementById('modalTitle').textContent = 'New Individual';
    document.getElementById('individualForm').reset();
    document.getElementById('individualId').value = '';
}

async function editIndividual(id) {
    const individual = individualsData.find(i => i.id === id);
    if (!individual) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Individual';
    document.getElementById('individualId').value = id;
    document.getElementById('individual_id').value = individual.individual_id || '';
    document.getElementById('aliases').value = individual.aliases || '';
    document.getElementById('family_id').value = individual.family_id || '';
    document.getElementById('sex').value = individual.sex || '';
    document.getElementById('phenotype').value = individual.phenotype || '';
    document.getElementById('projects').value = individual.projects || '';
    document.getElementById('other_family_codes').value = individual.other_family_codes || '';
    document.getElementById('notes').value = individual.notes || '';
    
    new bootstrap.Modal(document.getElementById('individualModal')).show();
}

async function saveIndividual() {
    const id = document.getElementById('individualId').value;
    const data = {
        individual_id: document.getElementById('individual_id').value || null,
        aliases: document.getElementById('aliases').value || null,
        family_id: document.getElementById('family_id').value || null,
        sex: document.getElementById('sex').value ? parseInt(document.getElementById('sex').value) : null,
        phenotype: document.getElementById('phenotype').value || null,
        projects: document.getElementById('projects').value || null,
        other_family_codes: document.getElementById('other_family_codes').value || null,
        notes: document.getElementById('notes').value || null
    };
    
    const url = id ? `/api/individuals/${id}` : '/api/individuals';
    const method = id ? 'PUT' : 'POST';
    
    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('individualModal')).hide();
            loadIndividuals();
        } else {
            const error = await response.json();
            alert(error.error || 'Error saving');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Connection error');
    }
}

async function deleteIndividual(id) {
    if (!confirm('Are you sure you want to delete this individual?')) return;
    
    try {
        const response = await fetch(`/api/individuals/${id}`, { method: 'DELETE' });
        if (response.ok) {
            loadIndividuals();
        } else {
            const error = await response.json();
            alert(error.error || 'Error deleting');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function showDetails(id) {
    const individual = individualsData.find(i => i.id === id);
    if (!individual) return;
    
    document.getElementById('detailsContent').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Identification</h6>
                <table class="table table-sm">
                    <tr><td>ID</td><td><strong>${individual.individual_id}</strong></td></tr>
                    <tr><td>Aliases</td><td>${individual.aliases || '-'}</td></tr>
                    <tr><td>Family ID</td><td>${individual.family_id || '-'}</td></tr>
                    <tr><td>Other Family Codes</td><td>${individual.other_family_codes || '-'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Information</h6>
                <table class="table table-sm">
                    <tr><td>Sex</td><td>${individual.sex_display}</td></tr>
                    <tr><td>Phenotype</td><td>${individual.phenotype || '-'}</td></tr>
                    <tr><td>Created</td><td>${individual.created_at ? new Date(individual.created_at).toLocaleDateString() : '-'}</td></tr>
                    <tr><td>Updated</td><td>${individual.updated_at ? new Date(individual.updated_at).toLocaleDateString() : '-'}</td></tr>
                </table>
            </div>
            <div class="col-12 mt-3">
                <h6>Projects</h6>
                <p>${individual.projects ? individual.projects.split(',').map(p => `<span class="badge bg-secondary me-1">${p.trim()}</span>`).join('') : '<span class="text-muted">None</span>'}</p>
            </div>
            <div class="col-12 mt-3">
                <h6>Samples: <span class="badge bg-primary">${individual.sample_count}</span></h6>
                ${individual.notes ? `<div class="alert alert-secondary mt-2"><strong>Notes:</strong> ${individual.notes}</div>` : ''}
            </div>
        </div>
    `;
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

// Event listeners
document.getElementById('searchInput').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') loadIndividuals();
});
document.getElementById('familyFilter').addEventListener('change', loadIndividuals);
document.getElementById('projectFilter').addEventListener('change', loadIndividuals);

// Initial load
document.addEventListener('DOMContentLoaded', () => {
    loadFilters();
    loadIndividuals();
});
</script>
{% endblock %}
